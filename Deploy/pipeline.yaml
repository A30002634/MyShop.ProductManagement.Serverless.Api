name: $(Date:yyyyMMdd).$(Rev:r)

trigger:
  batch: true
  branches:
    include:
    - master
    - feature/*

  paths:
    exclude:
     - doc
     - ReadME.md

pr:
  branches:
    include:
    - master

variables:
- name: vmImage
  value: 'windows-latest'

stages:
- stage: Build
  jobs:
  - job: 'Build'
    pool:
      vmImage: ${{variables.vmImage}}
    steps:
    - template: 'build.yaml'
      parameters:        
        projectFiles: '**/*.csproj'

- stage: DEV
  dependsOn: ['Build']
  jobs:
  - deployment: DEV
    variables:
    - template: 'Variables/dev.yaml'
    pool:
        vmImage: ${{variables.vmImage}}
    environment: DEV
    strategy:
      runOnce:
        deploy:
          steps:
          - template: 'deploy.yaml'  
            parameters:
              buildNumber: $(Build.BuildNumber)

- stage: MigrateDB
  dependsOn: ['Build']
  jobs:
  - deployment: DEV
    variables:
    - template: 'Variables/dev.yaml'
    pool:
        vmImage: ${{variables.vmImage}}
    environment: DEV
    strategy:
      runOnce:
        deploy:
          steps:
            - task: AzureFunction@1
              displayName: 'Migrate database'
              inputs:
                function: 'https://fn-funkyproductsapi-dev.azurewebsites.net/api/database'
                key: '$(functionMasterKey)'
                method: 'POST'
                headers: '{Content-Type:application/json}'     
                body: |
                  {
                    "input": "test"
                  }
                waitForCompletion: 'true'              
                        

